<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pip-Boy Timer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    :root{
      --g:#33ff66;
      --font:"Monofonto","Share Tech Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --scan-opacity:.55;
      --frame-radius:22px;
      --bezel:16px;
    }
    html,body{height:100%;margin:0;background:transparent;}
    *{box-sizing:border-box;}
    .wrap{height:100%;display:grid;place-items:center;padding:16px;}
    .crt{
      position:relative;width:min(1200px,96vw);aspect-ratio:16/7;border-radius:var(--frame-radius);overflow:hidden;
      background:
        radial-gradient(140% 120% at 50% 22%, rgba(51,255,102,.15), transparent 55%),
        radial-gradient(120% 120% at 50% 60%, rgba(51,255,102,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.75));
      border:2px solid rgba(51,255,102,.25);
      box-shadow:0 30px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
      transform:translateZ(0);
    }
    body.transparent .crt{background:transparent;box-shadow:none;border-color:rgba(51,255,102,.22);}

    .crt::before{
      content:"";position:absolute;inset:var(--bezel);
      border-radius:calc(var(--frame-radius) - 8px);
      border:2px solid rgba(51,255,102,.18);
      box-shadow:inset 0 0 0 2px rgba(0,0,0,.55);
      pointer-events:none;
    }
    .glow{position:absolute;inset:0;pointer-events:none;opacity:.85;mix-blend-mode:screen;
      background:
        radial-gradient(70% 90% at 50% 40%, rgba(51,255,102,.20), transparent 65%),
        radial-gradient(60% 80% at 50% 55%, rgba(51,255,102,.10), transparent 70%);
    }
    .scanlines{position:absolute;inset:0;pointer-events:none;opacity:var(--scan-opacity);
      background:repeating-linear-gradient(to bottom, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 2px, rgba(0,0,0,.30) 3px);
      animation:scanMove 7.5s linear infinite;
    }
    @keyframes scanMove{0%{transform:translateY(0)}100%{transform:translateY(26px)}}
    .vignette{position:absolute;inset:-18%;pointer-events:none;opacity:.85;
      background:radial-gradient(closest-side, transparent 55%, rgba(0,0,0,.65) 95%);
    }
    .grain{position:absolute;inset:0;pointer-events:none;opacity:.08;mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.45'/%3E%3C/svg%3E");
    }
    .flicker{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:.10;
      background:radial-gradient(50% 60% at 50% 50%, rgba(51,255,102,.28), transparent 70%);
      animation:flicker 6s infinite;
    }
    @keyframes flicker{0%,100%{opacity:.06}12%{opacity:.12}24%{opacity:.05}38%{opacity:.14}52%{opacity:.07}70%{opacity:.12}86%{opacity:.05}}

    .content{
      position:absolute;inset:calc(var(--bezel) + 10px);
      display:grid;grid-template-rows:auto auto 1fr;
      gap:10px;color:var(--g);font-family:var(--font);
      text-transform:uppercase;letter-spacing:.8px;
    }
    .tabs{display:flex;align-items:center;justify-content:center;gap:44px;
      font-size:clamp(14px,1.7vw,22px);padding-top:6px;text-shadow:0 0 14px rgba(51,255,102,.25);
    }
    .tabs span{opacity:.82;}
    .tabs .active{opacity:1;position:relative;}
    .tabs .active::before{content:"";position:absolute;left:-18px;top:50%;transform:translateY(-50%);
      width:9px;height:9px;border-radius:999px;background:var(--g);box-shadow:0 0 14px rgba(51,255,102,.55);
    }
    .subtabs{display:flex;align-items:center;justify-content:center;gap:34px;
      font-size:clamp(12px,1.3vw,18px);opacity:.85;letter-spacing:1.6px;
    }

    .panel{
      position:relative;border-radius:14px;border:2px solid rgba(51,255,102,.18);
      background:
        linear-gradient(180deg, rgba(51,255,102,.06), rgba(0,0,0,.12)),
        radial-gradient(120% 160% at 50% 30%, rgba(51,255,102,.12), transparent 60%);
      box-shadow:inset 0 0 0 2px rgba(0,0,0,.55);
      overflow:hidden;display:grid;place-items:center;padding:18px;
    }
    .edgeTicks{
      position:absolute;inset:10px;border-radius:10px;pointer-events:none;opacity:.55;
      background:
        repeating-linear-gradient(to right, rgba(51,255,102,.55) 0 2px, transparent 2px 18px),
        repeating-linear-gradient(to right, rgba(51,255,102,.55) 0 2px, transparent 2px 18px),
        repeating-linear-gradient(to bottom, rgba(51,255,102,.55) 0 2px, transparent 2px 18px),
        repeating-linear-gradient(to bottom, rgba(51,255,102,.55) 0 2px, transparent 2px 18px);
      background-size:100% 2px,100% 2px,2px 100%,2px 100%;
      background-position:top left,bottom left,top left,top right;
      background-repeat:no-repeat;
      filter:drop-shadow(0 0 8px rgba(51,255,102,.25));
    }
    .timerBlock{display:grid;place-items:center;gap:12px;width:100%;}
    .digits{
      font-size:clamp(52px,8.2vw,120px);
      letter-spacing:.08em;line-height:1;font-weight:400;
      text-shadow:0 0 16px rgba(51,255,102,.35), 0 0 40px rgba(51,255,102,.12);
      position:relative;
    }
    .digits::after{
      content:attr(data-ghost);position:absolute;left:1px;top:1px;opacity:.18;filter:blur(.3px);pointer-events:none;
    }
    .bottomLine{height:2px;background:linear-gradient(90deg,transparent,rgba(51,255,102,.22),transparent);
      opacity:.9;border-radius:999px;margin:2px 10px 0 10px;
    }
    .units{display:flex;align-items:center;justify-content:center;gap:26px;
      font-size:clamp(12px,1.6vw,22px);opacity:.9;letter-spacing:2px;
    }
    .units .sep{opacity:.75;color:rgba(51,255,102,.85);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="crt">
      <div class="glow"></div>
      <div class="scanlines"></div>
      <div class="grain"></div>
      <div class="flicker"></div>
      <div class="vignette"></div>

      <div class="content">
        <div class="tabs">
          <span class="active">START</span><span>INV</span><span>DATA</span><span>MAP</span><span>RADIO</span>
        </div>
        <div class="subtabs">
          <span>TIMER</span><span>HACKING</span><span>CONNECT</span><span>DIAGNOSTICS</span>
        </div>

        <div class="panel">
          <div class="edgeTicks"></div>
          <div class="timerBlock">
            <div class="digits" id="digits" data-ghost="00:00:00:00">00:00:00:00</div>
            <div class="bottomLine"></div>
            <div class="units">
              <span>DAYS</span><span class="sep">|</span>
              <span>HOURS</span><span class="sep">|</span>
              <span>MINUTES</span><span class="sep">|</span>
              <span>SECONDS</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const transparent = (qs.get("transparent") ?? "0") === "1";
    if (transparent) document.body.classList.add("transparent");

    // REQUIRED for remote control
    // Example: ?db=https://YOUR_DB.firebaseio.com&room=abc123
    const db = qs.get("db");        // Firebase RTDB base URL (no trailing slash)
    const room = qs.get("room");    // room id shared with controller
    if (!db || !room) {
      console.warn("Missing db/room params. Timer will stay at 00:00:00:00");
    }

    const digitsEl = document.getElementById("digits");
    const endpoint = (db && room) ? `${db.replace(/\/+$/,"")}/pipboyTimers/${encodeURIComponent(room)}.json` : null;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatElapsed(ms){
      const totalSec = Math.max(0, Math.floor(ms/1000));
      const days = Math.floor(totalSec/86400);
      const rem1 = totalSec - days*86400;
      const hours = Math.floor(rem1/3600);
      const rem2 = rem1 - hours*3600;
      const mins = Math.floor(rem2/60);
      const secs = rem2 - mins*60;
      return `${pad2(days)}:${pad2(hours)}:${pad2(mins)}:${pad2(secs)}`;
    }
    function setDigits(text){
      digitsEl.textContent = text;
      digitsEl.setAttribute("data-ghost", text);
    }

    let state = { startEpoch: null, stoppedAt: null };
    async function fetchState(){
      if (!endpoint) return;
      try{
        const res = await fetch(endpoint, { cache:"no-store" });
        const data = await res.json();
        if (data && typeof data === "object") {
          state.startEpoch = (typeof data.startEpoch === "number") ? data.startEpoch : null;
          state.stoppedAt  = (typeof data.stoppedAt  === "number") ? data.stoppedAt  : null;
        } else {
          state.startEpoch = null; state.stoppedAt = null;
        }
      } catch(e){
        // if Firebase hiccups briefly, keep last known state
      }
    }

    // Poll Firebase for state (reliable + simple)
    setInterval(fetchState, 750);
    fetchState();

    // Render loop (smooth display; state changes are picked up by polling)
    function render(){
      if (!state.startEpoch) {
        setDigits("00:00:00:00");
      } else {
        const end = (state.stoppedAt != null) ? state.stoppedAt : Date.now();
        setDigits(formatElapsed(end - state.startEpoch));
      }
      requestAnimationFrame(render);
    }
    render();
  </script>
</body>
</html>
